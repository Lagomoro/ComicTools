// ================================================================================
// * Module dependencies
// --------------------------------------------------------------------------------
import { defineComponent, PropType, ref } from 'vue';
// ================================================================================

export default defineComponent({
  props: {
    placeholder: { type: String,                      default: '拖拽文件到此，或点击选择文件' },
    clickHolder: { type: String,                      default: '点击选择文件' },
    dragHolder:  { type: String,                      default: '释放鼠标放置文件' },
    filter:      { type: Array as PropType<string[]>, default: [] },
  },
  emits: [
    'upload'
  ],
  setup(props, context){
    // ------------------------------------------------------------------------------
    // * Component
    // ------------------------------------------------------------------------------
    const fileInput = ref<HTMLInputElement>(null as unknown as HTMLInputElement);
    // ------------------------------------------------------------------------------
    // * Parameter
    // ------------------------------------------------------------------------------
    const isMoving = ref<boolean>(false);
    const isDragging = ref<boolean>(false);
    // ------------------------------------------------------------------------------
    // * Emit
    // ------------------------------------------------------------------------------
    function _upload(file?: File) {
      if (file && (props.filter.length === 0 || props.filter.filter(p => file.name.endsWith(`.${ p }`)).length > 0)) {
        context.emit('upload', file);
      }
    }
    // ------------------------------------------------------------------------------
    // * Function
    // ------------------------------------------------------------------------------
    //# region Drag
    // ------------------------------------------------------------------------------
    function onMouseOver() {
      isMoving.value = true;
    }

    function onMouseLeave() {
      isMoving.value = false;
    }
    // ------------------------------------------------------------------------------
    function onDragOver() {
      isDragging.value = true;
    }

    function onDragLeave() {
      isDragging.value = false;
    }

    function onDrop(event: DragEvent) {
      isDragging.value = false;
      _upload(event.dataTransfer?.files[0]);
    }
    // ------------------------------------------------------------------------------
    function onFileSelected() {
      _upload(fileInput.value.files?.[0]);
    }
    // ------------------------------------------------------------------------------
    //# endregion
    // ------------------------------------------------------------------------------
    //# region Button Events
    // ------------------------------------------------------------------------------
    function selectFile() {
      fileInput.value.click();
    }
    // ------------------------------------------------------------------------------
    //# endregion
    // ------------------------------------------------------------------------------

    return {
      // ------------------------------------------------------------------------------
      // * Component
      // ------------------------------------------------------------------------------
      fileInput,
      // ------------------------------------------------------------------------------
      // * Parameter
      // ------------------------------------------------------------------------------
      isMoving,
      isDragging,
      // ------------------------------------------------------------------------------
      // * Function
      // ------------------------------------------------------------------------------
      onMouseOver,
      onMouseLeave,
      // ------------------------------------------------------------------------------
      onDragOver,
      onDragLeave,
      onDrop,
      // ------------------------------------------------------------------------------
      onFileSelected,
      // ------------------------------------------------------------------------------
      selectFile,
    }
  }
});
